{% extends "users/dashboard_base.html" %}
{% load crispy_forms_tags %}
{% load form_tags %}

{% block dashboard_content %}
<h2>Edit Results for {{ student.get_full_name }}</h2>
<form method="post">
    {% csrf_token %}
    <div class="mb-3">
        <label for="exam">Exam:</label>
        <select id="exam" name="exam" class="form-control" required>
            <option value="">Select Exam</option>
            {% for exam in exams %}
                <option value="{{ exam.id }}">{{ exam.name }}</option>
            {% endfor %}
        </select>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Mark</th>
            </tr>
        </thead>
        <tbody>
            {% for class_subject in class_subjects %}
            <tr>
                <td>{{ class_subject.subject.name }}</td>
                <td>
                    <input type="number" name="mark_{{ class_subject.id }}" 
                           id="mark_{{ class_subject.id }}"
                           step="0.01" min="0" max="20" class="form-control">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Save Results</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
const results = {{ results_json|safe }};

document.getElementById('exam').addEventListener('change', function() {
    const examId = this.value;
    
    {% for class_subject in class_subjects %}
    (function() {
        const input{{ class_subject.id }} = document.getElementById('mark_{{ class_subject.id }}');
        const resultKey = '{{ class_subject.id }}_' + examId;
        input{{ class_subject.id }}.value = results[resultKey] || '';
    })();
    {% endfor %}
});

// Load initial results if an exam is pre-selected
window.addEventListener('load', function() {
    const examSelect = document.getElementById('exam');
    if (examSelect.value) {
        examSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}