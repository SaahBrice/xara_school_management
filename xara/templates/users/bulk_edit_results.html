{% extends "users/dashboard_base.html" %}
{% load crispy_forms_tags %}
{% load form_tags %}

{% block dashboard_content %}
<h2>Bulk Edit Results for {{ class.name }}</h2>
<form method="post">
    {% csrf_token %}
    <div class="mb-3">
        <label for="exam">Exam:</label>
        <select id="exam" name="exam" class="form-control" required>
            <option value="">Select Exam</option>
            {% for exam in exams %}
                <option value="{{ exam.id }}">{{ exam.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Student</th>
                    {% for class_subject in class_subjects %}
                    <th>{{ class_subject.subject.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.get_full_name }}</td>
                    {% for class_subject in class_subjects %}
                    <td>
                        <input type="number" name="mark_{{ student.id }}_{{ class_subject.id }}" 
                               id="mark_{{ student.id }}_{{ class_subject.id }}"
                               step="0.01" min="0" max="20" class="form-control">
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button type="submit" class="btn btn-primary">Save All Results</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
const results = {{ results_json|safe }};

document.getElementById('exam').addEventListener('change', function() {
    const examId = this.value;
    
    {% for student in students %}
        {% for class_subject in class_subjects %}
        (function() {
            const input{{ student.id }}_{{ class_subject.id }} = document.getElementById('mark_{{ student.id }}_{{ class_subject.id }}');
            const resultKey = '{{ student.id }}_{{ class_subject.id }}_' + examId;
            input{{ student.id }}_{{ class_subject.id }}.value = results[resultKey] || '';
        })();
        {% endfor %}
    {% endfor %}
});

// Load initial results if an exam is pre-selected
window.addEventListener('load', function() {
    const examSelect = document.getElementById('exam');
    if (examSelect.value) {
        examSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}